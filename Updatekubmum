<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î | Hat Yai Clean</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; height: 100%; background: #f4f4f9; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .bottom-panel { position: fixed; bottom: 0; left: 0; right: 0; background: white; z-index: 1000; padding: 25px; border-radius: 30px 30px 0 0; box-shadow: 0 -10px 25px rgba(0,0,0,0.15); max-height: 45vh; overflow-y: auto; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-section h2 { margin: 0; color: #2d3436; font-size: 1.6em; font-weight: 600; }
        .btn { border: none; padding: 14px; border-radius: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; font-family: 'Kanit', sans-serif; width: 100%; margin-bottom: 12px; font-size: 1em; }
        .btn-primary { background: #0984e3; color: white; box-shadow: 0 4px 15px rgba(9, 132, 227, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-danger { background: #d63031; color: white; box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3); }
        .btn-outline { background: #ffffff; border: 2px solid #dfe6e9; color: #636e72; }
        .btn-outline.active { background: #00b894; color: white; border-color: #00b894; }
        .filter-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .report-box { background: #fffaf0; padding: 20px; border-radius: 20px; border: 1px solid #ffeaa7; }
        select.btn-outline { appearance: none; -webkit-appearance: none; padding-left: 15px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="bottom-panel">
        <div class="header-section">
            <h2>üåç ‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h2>
            <button onclick="toggleAdmin()" style="background:none; border:none; color:#b2bec3; cursor:pointer; font-size: 0.9em;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <button class="btn btn-primary" onclick="findMyLocation()">üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div class="filter-row">
            <button class="btn btn-outline active" onclick="filterMap('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', this)">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•', this)">‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', this)">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</button>
        </div>
        <div class="report-box">
            <p style="margin-top:0; font-weight:600; color: #d63031;">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏¢‡∏∞‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà</p>
            <select id="issueType" class="btn btn-outline" style="text-align:left; margin-bottom: 15px;">
                <option value="‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°</option>
                <option value="‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
                <option value="‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ñ‡∏∑‡πà‡∏≠‡∏ô">‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ñ‡∏∑‡πà‡∏≠‡∏ô</option>
            </select>
            <button class="btn btn-danger" id="reportBtn" onclick="sendReport()">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywYJYWejQDLj5NDUxHnLWtewGD90CAS8WDweRRwssneRIa98v2jXQaGdowr7lb7iJUMw/exec"; 
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1K8iiW-yG929fjaDvFr_ZO6Vs8T6YrkJCDg3AjNdyx4g/edit?gid=1264498173#gid=1264498173";
        // -----------------------

        const map = L.map('map', { zoomControl: false }).setView([7.0104, 100.4747], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markerLayer = L.layerGroup().addTo(map);
        let userMarker; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        let rawData = [];

        async function loadData() {
            if(SCRIPT_URL.includes("script.google.com")) {
                try {
                    const res = await fetch(SCRIPT_URL);
                    rawData = await res.json();
                    renderMarkers('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                } catch (e) { console.error("Data error", e); }
            }
        }

        function renderMarkers(type) {
            markerLayer.clearLayers();
            rawData.forEach(p => {
                if (type === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || p.type === type) {
                    L.marker([p.lat, p.lng]).addTo(markerLayer)
                     .bindPopup(`<b>${p.name}</b><br>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${p.type}`);
                }
            });
        }

        function filterMap(type, btn) {
            document.querySelectorAll('.btn-outline').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMarkers(type);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏î‡∏á
        function findMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    if (userMarker) { map.removeLayer(userMarker); }

                    // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà
                    userMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup("<b>‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</b><br>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
                        .openPopup();

                    map.setView([lat, lng], 17);
                }, function() {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
                });
            }
        }

        async function sendReport() {
            const btn = document.getElementById('reportBtn');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
                const data = { 
                    lat: pos.coords.latitude, 
                    lng: pos.coords.longitude, 
                    issue: document.getElementById('issueType').value 
                };
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' });
                    alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á! ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e); }
                btn.disabled = false; btn.innerText = "‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            }, () => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"));
        }

        function toggleAdmin() { window.open(SHEET_URL, "_blank"); }
        loadData();
    </script>
</body>
</html>
