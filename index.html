<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î | Hat Yai Clean</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body, html { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; height: 100%; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .bottom-panel { position: fixed; bottom: 0; left: 0; right: 0; background: white; z-index: 1000; padding: 20px; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 40vh; overflow-y: auto; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-section h2 { margin: 0; color: #28a745; font-size: 1.4em; }
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: 'Kanit', sans-serif; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-outline { background: #f8f9fa; border: 1px solid #ddd; }
        .btn-outline.active { background: #28a745; color: white; border-color: #28a745; }
        .filter-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .report-box { background: #fff5f5; padding: 15px; border-radius: 12px; border: 1px solid #feb2b2; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="bottom-panel">
        <div class="header-section">
            <h2>üìç ‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h2>
            <button onclick="toggleAdmin()" style="background:none; border:none; color:#999; cursor:pointer;">‡πÅ‡∏ú‡πà‡∏ô‡∏ä‡∏µ‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <button class="btn btn-primary" onclick="findMyLocation()">üîç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <div class="filter-row">
            <button class="btn btn-outline active" onclick="filterMap('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', this)">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•', this)">‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</button>
            <button class="btn btn-outline" onclick="filterMap('‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', this)">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</button>
        </div>
        <div class="report-box">
            <p style="margin-top:0; font-weight:600;">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°/‡∏ä‡∏≥‡∏£‡∏∏‡∏î</p>
            <select id="issueType" class="btn btn-outline" style="text-align:left;">
                <option value="‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°</option>
                <option value="‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
                <option value="‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ñ‡∏∑‡πà‡∏≠‡∏ô">‡∏à‡∏∏‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ñ‡∏∑‡πà‡∏≠‡∏ô</option>
            </select>
            <button class="btn btn-danger" id="reportBtn" onclick="sendReport()">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVNMtLs4J48XXNQLcsEXBzeMzX9iSokW4N6-K6kW4KRhE6XXKlC_L4DMt37AKCbtY2EA/exec"; 
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1K8iiW-yG929fjaDvFr_ZO6Vs8T6YrkJCDg3AjNdyx4g/edit?gid=1264498173#gid=1264498173";
        // -----------------------

        const map = L.map('map', { zoomControl: false }).setView([7.0104, 100.4747], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markerLayer = L.layerGroup().addTo(map);
        let rawData = [];

        async function loadData() {
            if(SCRIPT_URL.includes("‡∏ß‡∏≤‡∏á_WEB_APP")) return;
            try {
                const res = await fetch(SCRIPT_URL);
                rawData = await res.json();
                renderMarkers('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
            } catch (e) { console.error("Data error", e); }
        }

        function renderMarkers(type) {
            markerLayer.clearLayers();
            rawData.forEach(p => {
                if (type === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || p.type === type) {
                    const navUrl = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
                    L.marker([p.lat, p.lng]).addTo(markerLayer)
                     .bindPopup(`<b>${p.name}</b><br>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${p.type}<br><a href="${navUrl}" target="_blank" style="display:block; margin-top:5px; color:green; font-weight:bold;">üöó ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>`);
                }
            });
        }

        function filterMap(type, btn) {
            document.querySelectorAll('.btn-outline').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMarkers(type);
        }

        async function sendReport() {
            const btn = document.getElementById('reportBtn');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
                const data = { lat: pos.coords.latitude, lng: pos.coords.longitude, issue: document.getElementById('issueType').value };
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' });
                    alert("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                } catch (e) { alert("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + e); }
                btn.disabled = false; btn.innerText = "‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà";
            }, () => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"));
        }

        function findMyLocation() { map.locate({setView: true, maxZoom: 16}); }
        function toggleAdmin() { window.open(SHEET_URL, "_blank"); }
        loadData();
    </script>
</body>
</html>
